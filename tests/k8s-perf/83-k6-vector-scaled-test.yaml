apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-vector-scaled-script
  namespace: chronik-perf
data:
  vector-scaled-test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate, Trend, Counter } from 'k6/metrics';

    const vectorErrors = new Rate('vector_errors');
    const vectorLatency = new Trend('vector_latency', true);
    const vectorCompleted = new Counter('vector_completed');
    const hybridErrors = new Rate('hybrid_errors');
    const hybridLatency = new Trend('hybrid_latency', true);
    const hybridCompleted = new Counter('hybrid_completed');
    const totalErrors = new Rate('total_errors');
    const totalLatency = new Trend('total_latency', true);

    const BASE_URL = __ENV.CHRONIK_URL || 'http://chronik-query.chronik-perf.svc.cluster.local:6092';
    const VECTOR_TOPIC = __ENV.VECTOR_TOPIC || 'query-bench-vector';

    export const options = {
      stages: [
        { duration: '15s', target: 20 },
        { duration: '30s', target: 100 },
        { duration: '1m',  target: 200 },
        { duration: '1m',  target: 200 },
        { duration: '30s', target: 100 },
        { duration: '15s', target: 0 },
      ],
      thresholds: {
        total_errors: ['rate<0.10'],
      },
    };

    const queries = [
      'encryption', 'Kubernetes', 'pricing', 'timeout', 'PostgreSQL',
      'monitoring', 'deployment', 'firewall', 'API', 'backup',
      'connection timeout error', 'auto scaling configuration',
      'load balancer setup', 'database connection pool',
      'TLS certificate renewal', 'budget alert threshold',
      'container deployment rollback', 'GPU instance types',
      'how to fix 502 error', 'configure auto scaling group',
      'set up monitoring dashboard', 'enable encryption at rest',
      'troubleshoot memory leak', 'optimize query performance',
    ];

    const headers = { 'Content-Type': 'application/json' };

    export default function () {
      const q = queries[Math.floor(Math.random() * queries.length)];
      const k = Math.random() < 0.7 ? 5 : 10;
      const doHybrid = Math.random() < 0.4;

      let res;
      if (doHybrid) {
        const vw = 0.5 + Math.random() * 0.4;
        res = http.post(
          `${BASE_URL}/_vector/${VECTOR_TOPIC}/hybrid`,
          JSON.stringify({ query: q, k: k, vector_weight: vw, text_weight: 1.0 - vw }),
          { headers, timeout: '30s' }
        );
        const ok = check(res, { 'hybrid 200': (r) => r.status === 200 });
        hybridErrors.add(!ok);
        hybridLatency.add(res.timings.duration);
        if (ok) hybridCompleted.add(1);
        totalErrors.add(!ok);
        totalLatency.add(res.timings.duration);
      } else {
        res = http.post(
          `${BASE_URL}/_vector/${VECTOR_TOPIC}/search`,
          JSON.stringify({ query: q, k: k }),
          { headers, timeout: '30s' }
        );
        const ok = check(res, { 'vector 200': (r) => r.status === 200 });
        vectorErrors.add(!ok);
        vectorLatency.add(res.timings.duration);
        if (ok) vectorCompleted.add(1);
        totalErrors.add(!ok);
        totalLatency.add(res.timings.duration);
      }
      sleep(0.02);
    }
---
apiVersion: k6.io/v1alpha1
kind: TestRun
metadata:
  name: k6-vector-scaled
  namespace: chronik-perf
spec:
  parallelism: 4
  script:
    configMap:
      name: k6-vector-scaled-script
      file: vector-scaled-test.js
  runner:
    image: grafana/k6:0.49.0
    resources:
      requests:
        cpu: "2"
        memory: "1Gi"
      limits:
        cpu: "8"
        memory: "4Gi"
    env:
      - name: CHRONIK_URL
        value: "http://chronik-query.chronik-perf.svc.cluster.local:6092"
      - name: VECTOR_TOPIC
        value: "query-bench-vector"
