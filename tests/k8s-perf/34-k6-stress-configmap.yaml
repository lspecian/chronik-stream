apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-stress-test-script
  namespace: chronik-perf
data:
  stress-test.js: |
    import http from 'k6/http';
    import { check } from 'k6';
    import { Rate, Trend, Counter } from 'k6/metrics';

    const produceErrors = new Rate('produce_errors');
    const batchLatency = new Trend('batch_latency', true);
    const messagesProduced = new Counter('messages_produced');

    const BASE_URL = __ENV.INGESTOR_URL || 'http://ingestor.chronik-perf.svc.cluster.local:8080';

    export const options = {
      stages: [
        { duration: '30s',  target: 200 },
        { duration: '1m',   target: 1000 },
        { duration: '2m',   target: 3000 },
        { duration: '5m',   target: 5000 },
        { duration: '3m',   target: 8000 },
        { duration: '2m',   target: 3000 },
        { duration: '1m',   target: 0 },
      ],
      thresholds: {},
      noConnectionReuse: false,
    };

    // Batch size: 100 messages per HTTP request to amortize HTTP overhead
    const BATCH_SIZE = 100;
    const MSG_SIZE = 256;

    // Pre-generate a fixed payload once (much faster than per-message random generation)
    const CHARS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let FIXED_PAYLOAD = '';
    for (let i = 0; i < MSG_SIZE; i++) {
      FIXED_PAYLOAD += CHARS.charAt(Math.floor(Math.random() * CHARS.length));
    }

    export default function () {
      const headers = { 'Content-Type': 'application/json' };
      const batch = [];
      for (let i = 0; i < BATCH_SIZE; i++) {
        batch.push({
          key: `k6-${__VU}-${__ITER}-${i}`,
          value: FIXED_PAYLOAD,
        });
      }
      // Use blocking batch endpoint â€” waits for actual Kafka delivery (acks=1)
      const res = http.post(`${BASE_URL}/produce/batch`, JSON.stringify(batch), {
        headers,
        timeout: '30s',
      });
      const ok = check(res, { 'batch status 200': (r) => r.status === 200 });
      produceErrors.add(!ok);
      batchLatency.add(res.timings.duration);
      if (ok) messagesProduced.add(BATCH_SIZE);
    }
