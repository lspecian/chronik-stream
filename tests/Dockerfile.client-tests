# Dockerfile for running Kafka client compatibility tests
FROM ubuntu:22.04

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install base dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    build-essential \
    python3 \
    python3-pip \
    golang-go \
    default-jdk \
    maven \
    && rm -rf /var/lib/apt/lists/*

# Install kafkactl
RUN curl -L https://github.com/deviceinsight/kafkactl/releases/latest/download/kafkactl-linux-amd64 \
    -o /usr/local/bin/kafkactl \
    && chmod +x /usr/local/bin/kafkactl

# Install Python Kafka client
RUN pip3 install confluent-kafka pytest

# Install Go and Sarama
ENV GOPATH=/go
ENV PATH=$GOPATH/bin:$PATH
RUN go install github.com/Shopify/sarama/tools/kafka-console-consumer@latest \
    && go install github.com/Shopify/sarama/tools/kafka-console-producer@latest

# Install kcat (formerly kafkacat)
RUN apt-get update && apt-get install -y kafkacat && rm -rf /var/lib/apt/lists/*

# Install Node.js and node-rdkafka (optional)
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs \
    && npm install -g node-rdkafka

# Set working directory
WORKDIR /tests

# Create a test runner script
RUN echo '#!/bin/bash\n\
echo "Kafka Client Test Environment"\n\
echo "============================"\n\
echo "Available tools:"\n\
echo "  - kafkactl: $(kafkactl version 2>/dev/null || echo "installed")"\n\
echo "  - kcat: $(kcat -V 2>&1 | head -1)"\n\
echo "  - python3: $(python3 --version)"\n\
echo "  - go: $(go version)"\n\
echo "  - java: $(java -version 2>&1 | head -1)"\n\
echo ""\n\
echo "Python packages:"\n\
python3 -c "import confluent_kafka; print(f\"  - confluent-kafka: {confluent_kafka.version()}\")"\n\
echo ""\n\
echo "Ready to run tests!"' > /usr/local/bin/test-env-info \
    && chmod +x /usr/local/bin/test-env-info

# Default command
CMD ["test-env-info"]