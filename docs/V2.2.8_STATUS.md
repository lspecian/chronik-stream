# v2.2.8 Status Report

**Date:** 2025-11-09
**Severity:** CRITICAL BLOCKER (Partial Fix)

---

## Summary

v2.2.8 attempted to fix TWO critical cluster bugs:
1. ‚úÖ **FIXED**: IntegratedKafkaServer::new() chicken-and-egg deadlock
2. ‚ùå **BLOCKED**: Broker registration deadlock (Raft state machine issue)
3. ‚úÖ **IMPLEMENTED**: Auto-create topic fix for followers (UNTESTED - blocked by #2)

---

## What Was Fixed (v2.2.8)

### 1. IntegratedKafkaServer::new() Deadlock ‚úÖ

**Problem:**
- `IntegratedKafkaServer::new()` waited for Raft leader election (lines 390-416)
- Raft message loop starts AFTER `new()` returns (main.rs:615)
- **Result**: new() never returns ‚Üí message loop never starts ‚Üí deadlock

**Fix:**
- Removed blocking leader election wait from `integrated_server.rs`
- Moved partition metadata initialization to main.rs (AFTER Raft loop starts)
- **Files changed:**
  - [integrated_server.rs](../crates/chronik-server/src/integrated_server.rs) - Deleted lines 390-522
  - [main.rs](../crates/chronik-server/src/main.rs) - Spawned broker registration in background task (lines 665-704)

**Result**: IntegratedKafkaServer::new() NOW COMPLETES! ‚úÖ

---

### 2. Auto-Create Topic Fix for Followers ‚úÖ

**Problem** (from v2.2.7):
- Followers auto-created topics locally without Raft consensus
- Left partitions without leader/ISR ‚Üí continuous "No ISR found" errors
- 99% throughput degradation (10 req/s instead of 1000+)

**Fix** (produce_handler.rs):
- Lines 2095-2138: Leader-only partition initialization with follower wait logic
- Lines 2405-2413: Changed follower early-return to programming error

**Status**: ‚úÖ IMPLEMENTED BUT **UNTESTED** (blocked by broker registration bug)

---

## What Remains Broken (CRITICAL)

### Broker Registration Deadlock ‚ùå

**Problem:**
- `register_broker()` calls `raft.propose(RegisterBroker).await` (raft_metadata_store.rs:174)
- Waits for Raft entry to be committed AND applied to state machine (lines 187-202)
- **State machine application NEVER COMPLETES**
- Entries persist to WAL ‚úÖ but never apply to in-memory state ‚ùå

**Evidence:**
```bash
# Logs show task starts but NEVER completes:
[INFO] This node is the Raft leader - spawning broker registration task
[INFO] Background task: Registering 3 brokers from config
[INFO] Raft ready: 2 unpersisted messages to send
[INFO] Persisting 2 Raft entries to WAL
[INFO] ‚úì Persisted 2 Raft entries to WAL
# ‚ùå NEVER SEE: "Successfully registered broker 1"
# ‚ùå NEVER SEE: "Successfully registered broker 2"
# ‚ùå NEVER SEE: "Successfully registered broker 3"
```

**Impact:**
- NO brokers registered ‚Üí Kafka clients timeout ‚Üí cluster COMPLETELY UNUSABLE
- Auto-create fix CANNOT BE TESTED

**Root Cause:**
- Raft state machine application logic is fundamentally broken
- NOT a concurrency issue (spawning background task didn't help)
- Requires deep architectural changes to Raft apply logic

**Scope**: BEYOND v2.2.8 - defer to v2.2.9

---

## Testing Status

### What Can Be Tested

1. ‚úÖ **IntegratedKafkaServer::new() completes**
   ```bash
   grep "IntegratedKafkaServer initialized successfully" tests/cluster/logs/node1.log
   # ‚úÖ APPEARS in logs
   ```

2. ‚úÖ **Raft message loop starts**
   ```bash
   grep "Raft message loop started successfully" tests/cluster/logs/node1.log
   # ‚úÖ APPEARS in logs
   ```

3. ‚úÖ **Broker registration task spawns**
   ```bash
   grep "Broker registration task spawned" tests/cluster/logs/node1.log
   # ‚úÖ APPEARS in logs
   ```

### What CANNOT Be Tested

1. ‚ùå **Broker registration completion**
   ```bash
   grep "Successfully registered broker" tests/cluster/logs/node1.log
   # ‚ùå NEVER APPEARS
   ```

2. ‚ùå **Kafka client connections**
   ```bash
   python3 /tmp/test_follower_autocreate.py
   # ‚ùå KafkaTimeoutError: Failed to update metadata after 60.0 secs
   ```

3. ‚ùå **Auto-create fix verification**
   - Cannot test because NO BROKERS are registered
   - Clients timeout before reaching auto-create code path

---

## Recommended Path Forward

### Option 1: Fix Raft State Machine Application (v2.2.9)

**High effort, high impact:**
- Investigate why Raft entries persist but don't apply
- Check RaftCluster::apply() implementation
- Verify state machine Ready message handling
- Add extensive debug logging to Raft apply path

**Estimated complexity**: 2-4 hours of deep debugging

### Option 2: Bypass Raft for Initial Broker Registration (Quick Fix)

**Low effort, medium impact:**
- Allow leader to write brokers directly to local state machine (WITHOUT Raft consensus)
- Only for initial cluster bootstrap
- Followers still receive via Raft replication (once applying works)

**Trade-off**: Less consistent but unblocks testing

### Option 3: Test Auto-Create Fix in Single-Node Mode

**Immediate testing path:**
- Single-node mode doesn't use Raft
- Can test auto-create fix independently
- Won't catch cluster-specific issues

---

## Recommendation

**STOP v2.2.8 development** - DO NOT release

Fixing the Raft state machine application issue is CRITICAL and COMPLEX. This is not a quick fix - it requires:
1. Deep understanding of Raft Ready message processing
2. Debugging why apply() is called but state doesn't update
3. Potentially fixing a fundamental design flaw in RaftMetadataStore

**Next steps:**
1. Create v2.2.9 milestone for Raft state machine fix
2. Document detailed Raft apply flow for investigation
3. Add debug logging to every step of Raft entry application
4. Consider consulting Raft library documentation for proper apply semantics

---

## Files Modified (v2.2.8)

1. ‚úÖ [produce_handler.rs](../crates/chronik-server/src/produce_handler.rs) - Auto-create fix
2. ‚úÖ [integrated_server.rs](../crates/chronik-server/src/integrated_server.rs) - Removed deadlock
3. ‚úÖ [main.rs](../crates/chronik-server/src/main.rs) - Background broker registration
4. üìù [INTEGRATED_SERVER_HANGS_v2.2.8.md](./INTEGRATED_SERVER_HANGS_v2.2.8.md) - Deadlock analysis
5. üìù [BROKER_REGISTRATION_BUG_v2.2.8.md](./BROKER_REGISTRATION_BUG_v2.2.8.md) - Updated root cause
6. üìù [AUTO_CREATE_TOPIC_BUG_v2.2.7.md](./AUTO_CREATE_TOPIC_BUG_v2.2.7.md) - Original bug report

---

## Conclusion

v2.2.8 made PROGRESS but discovered a DEEPER blocker:
- Fixed one chicken-and-egg deadlock ‚úÖ
- Implemented auto-create fix ‚úÖ
- Discovered Raft state machine application is fundamentally broken ‚ùå

**The cluster is STILL UNUSABLE** until Raft apply is fixed.

DO NOT release v2.2.8.

Recommend creating v2.2.9 milestone for Raft state machine investigation.
